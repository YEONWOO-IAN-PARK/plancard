<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.junebay.plancard.card.mapper.CountryMapper">

	<!-- 탐험카드 반환을 위한 ResultMap -->
	<resultMap id="countryDTOResultMap" type="com.junebay.plancard.card.dto.CountryDTO">
		<id property="countryId" column="id"/>
		<result property="title" column="title"/>
		<result property="description" column="description"/>
		<result property="imageUrl" column="image_url"/>
	</resultMap>

	<sql id="filterCondition">
		<where>
		/* 필터: 국가 */
		<if test='requestDTO.filter != null and requestDTO.filter.country != null and !"".equals(requestDTO.filter.country)'>
			c.id = #{requestDTO.filter.country}
		</if>

		/* 필터: 테마 */
		<if test="requestDTO.filter != null and requestDTO.filter.theme != null and requestDTO.filter.theme.size() > 0">
			EXISTS (
				SELECT	1
				FROM	country_theme t
				WHERE	t.country_id = c.id
						AND t.theme_id IN
					<foreach item="themeId" collection="requestDTO.filter.theme" open="(" separator="," close=")">
						#{themeId}
					</foreach>
			)
		</if>
		</where>
	</sql>

	<select id="selectCountries" resultMap="countryDTOResultMap" parameterType="com.junebay.plancard.common.dto.RequestDTO">
		SELECT	id
				, name AS title
				, description
				, CONCAT('/images/countries/', id)  AS image_url
		FROM	countries c
		<include refid="filterCondition" />
		<include refid="common.sortCondition" />
		<include refid="common.paginationCondition" />
	</select>

</mapper>